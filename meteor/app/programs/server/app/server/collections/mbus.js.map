{"version":3,"sources":["meteor://ðŸ’»app/server/collections/mbus.js"],"names":[],"mappings":"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","file":"/server/collections/mbus.js","sourcesContent":["Mbus.allow({\n\tinsert: function (userId, doc) {\n\t\treturn Mbus.userCanInsert(userId, doc);\n\t},\n\n\tupdate: function (userId, doc, fields, modifier) {\n\t\treturn Mbus.userCanUpdate(userId, doc);\n\t},\n\n\tremove: function (userId, doc) {\n\t\treturn Mbus.userCanRemove(userId, doc);\n\t}\n});\n\nMbus.before.insert(function(userId, doc) {\n\tdoc.createdAt = new Date();\n\tdoc.createdBy = userId;\n\tdoc.modifiedAt = doc.createdAt;\n\tdoc.modifiedBy = doc.createdBy;\n\n\t\n\tif(!doc.createdBy) doc.createdBy = userId;\n});\n\nMbus.before.update(function(userId, doc, fieldNames, modifier, options) {\n\tmodifier.$set = modifier.$set || {};\n\tmodifier.$set.modifiedAt = new Date();\n\tmodifier.$set.modifiedBy = userId;\n\n\t\n});\n\nMbus.before.remove(function(userId, doc) {\n\t\n});\n\nMbus.after.insert(function(userId, doc) {\n\t\n});\n\nMbus.after.update(function(userId, doc, fieldNames, modifier, options) {\n\tconsole.log(\"Mbus - afterUpdate\");\n\tvar message = doc.message;\n    var sensorArr = [];\n    for (var key in message) {\n        if (message.hasOwnProperty(key)) {\n            var sensorid = key;\n\t\t\tfor(var valuekey in message[key]){\n\t\t\t\tvar tempObj = {};  \n\t\t\t\ttempObj[\"signal\"] = sensorid;\n\t\t\t\ttempObj[\"value\"] = message[key].value;\n\t\t\t\ttempObj[\"timestamp\"] = new Date(message[key].time);\n\t\t\t\ttempObj[\"unit\"] = message[key].unit;\n\t\t\t\tsensorArr.push(tempObj);\n\t\t\t}\n        }\n    }\n\n    sensorArr.forEach(function(sensor,i){\n\t\tvar searchSignal = Signals.findOne({\"signal\":sensor.signal});\n\t\tif(searchSignal !== undefined){\n\t\t\tvar offsetA = searchSignal.offsetA;\n\t\t\tvar offsetB = searchSignal.offsetB;\n\t\t\tvar scale = searchSignal.scale;\n\t\t\tSignals.upsert({\"signal\":sensor.signal},{$set:{value: scale*(sensor.value+offsetA)+offsetB, raw: sensor.value, timestamp: sensor.timestamp}});\n\t\t}\n\t\telse{\n\t\t\tSignals.upsert({\"signal\":sensor.signal},{$set:{name: null, bus: \"mbus\", value: sensor.value, raw: sensor.value, timestamp: sensor.timestamp, unit: sensor.unit, offsetA: 0.0, offsetB: 0.0, scale: 1.0, hidden: false}});\n\t\t}\n\t});\n});\n\nMbus.after.remove(function(userId, doc) {\n\t\n});\n"]}