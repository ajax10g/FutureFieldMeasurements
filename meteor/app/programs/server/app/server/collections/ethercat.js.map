{"version":3,"sources":["meteor://ðŸ’»app/server/collections/ethercat.js"],"names":[],"mappings":"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","file":"/server/collections/ethercat.js","sourcesContent":["Ethercat.allow({\n\tinsert: function (userId, doc) {\n\t\treturn Ethercat.userCanInsert(userId, doc);\n\t},\n\n\tupdate: function (userId, doc, fields, modifier) {\n\t\treturn Ethercat.userCanUpdate(userId, doc);\n\t},\n\n\tremove: function (userId, doc) {\n\t\treturn Ethercat.userCanRemove(userId, doc);\n\t}\n});\n\nEthercat.before.insert(function(userId, doc) {\n\tdoc.createdAt = new Date();\n\tdoc.createdBy = userId;\n\tdoc.modifiedAt = doc.createdAt;\n\tdoc.modifiedBy = doc.createdBy;\n\n\t\n\tif(!doc.createdBy) doc.createdBy = userId;\n});\n\nfunction getEthercatValue(_in) {\n    //console.log(_in);\n    var values = Ethercat.findOne();\n    if (values) {\n        var memory = [];\n        values.message.obytes.forEach(function(o, i) {\n            memory.push(o);\n        });\n        values.message.ibytes.forEach(function(o, i) {\n            memory.push(o);\n        });\n        \n        var oby = _in.offsetbyte;\n        var obi = _in.offsetbit;\n        var bl = _in.bitlength;\n        \n        var nofBytesWithOffset = Math.ceil((bl+obi)/8);\n        var nofBitsWithOffset = (bl+obi) % 8;\n        \n        //Group affected bytes into an int\n        var appendedMemory = 0;\n        for(var i = 0;i < nofBytesWithOffset;i++){ \n            appendedMemory += (memory[oby+i] << (8*i));\n        }\n        \n        var mask = 1;\n        for(var i = 1; i<bl;i++){ //append ones\n            mask = (mask << 1);\n            mask += 1;\n        }\n        \n        for(var i = 0; i<obi;i++){ //append zeros\n            mask = (mask << 1);\n        }\n        return (appendedMemory & mask) >> obi;\n    } else {\n        throw new Meteor.Error(\"No EtherCat data available.\");\n    }\n}\n\nEthercat.before.update(function(userId, doc, fieldNames, modifier, options) {\n\tmodifier.$set = modifier.$set || {};\n\tmodifier.$set.modifiedAt = new Date();\n\tmodifier.$set.modifiedBy = userId;\n\n\t\n});\n\nEthercat.before.remove(function(userId, doc) {\n\t\n});\n\nEthercat.after.insert(function(userId, doc) {\n\t\n});\n\nEthercat.after.update(function(userId, doc, fieldNames, modifier, options) {\n\tconsole.log(\"Ethercat - afterUpdate\");\n\tvar esignals = Signals.find({bus: \"ethercat\"});\n\tesignals.forEach(function(sig,i){\n\t\tvar val = getEthercatValue(sig);\n\t\tSignals.update(sig._id,{$set:{value: sig.scale*(val+sig.offsetA)+sig.offsetB, raw: val, timestamp: doc.message.time}})\n\t});\n});\n\nEthercat.after.remove(function(userId, doc) {\n\t\n});\n"]}